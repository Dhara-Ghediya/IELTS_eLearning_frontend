{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <div style="background-color: rgb(249, 249, 249)">
        <div class="d-flex align-items-start">
            <div class="nav flex-column nav-pills me-3" style="border-radius: 5px" id="v-pills-tab" role="tablist"
                aria-orientation="vertical">
                <button class="nav-link active d-flex align-items-center justify-content-center"
                    style="border-radius: 5px 0px 0px 0px" id="v-pills-home-tab" data-bs-toggle="pill"
                    data-bs-target="#v-pills-home" type="button" role="tab" aria-controls="v-pills-home"
                    aria-selected="true">
                    writing
                    <i class="fa fa-pen ms-2 mt-1"></i>
                </button>
                <button class="nav-link d-flex align-items-center justify-content-center" id="v-pills-profile-tab"
                    data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab"
                    aria-controls="v-pills-profile" aria-selected="false">
                    listening
                    <i class="fa fa-assistive-listening-systems ms-2"></i>
                </button>
                <button class="nav-link d-flex align-items-center justify-content-center" id="v-pills-messages-tab"
                    data-bs-toggle="pill" data-bs-target="#v-pills-messages" type="button" role="tab"
                    aria-controls="v-pills-messages" aria-selected="false">
                    reading
                    <i class="fas fa-book-reader ms-2"></i>
                </button>
                <button class="nav-link d-flex align-items-center justify-content-center" id="v-pills-settings-tab"
                    data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button" role="tab"
                    aria-controls="v-pills-settings" style="border-radius: 0 0 0 5px" aria-selected="false">
                    speaking
                    <i class="fas fa-spider-black-widow"></i>
                </button>
            </div>
            <div class="tab-content w-100" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel"
                    aria-labelledby="v-pills-home-tab">
                    <div class="table-responsive container mt-4 w-100">
                        <div style="min-height: 650px">
                            <table class="table table-hover	table-responsive align-middle">
                                    <thead class="table-secondary">
                                        <caption>Good luck for next test</caption>
                                        <tr>
                                            <th>No</th>
                                            <th id="timeWriting">time <i class='fas fa-angle-down'></i></th>
                                            <th id="professorWriting">professor </th>
                                            <th id="professorEmailWriting">professor Email </i></th>
                                            <th id="statusWriting">status <i class='fas fa-angle-down'></i></th>
                                            <th id="marksWriting">marks <i class='fas fa-angle-down'></i></th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider" id="recordWritingShow">
                                    </tbody>
                                    <tfoot>

                                    </tfoot>
                            </table>
                        </div>
                        <div id="writingpagination" class="mt-3"></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
                    <div class="table-responsive container mt-4 w-100">
                        <div style="min-height: 650px">
                            <table class="table table-hover	table-responsive align-middle">
                                    <thead class="table-secondary">
                                        <caption>Good luck for next test</caption>
                                        <tr>
                                            <th>No</th>
                                            <th id="timeListening">time <i class='fas fa-angle-down'></i></th>
                                            <th id="professorListening">professor </th>
                                            <th id="professorEmailListening">professor Email </i></th>
                                            <th id="statusListening">status <i class='fas fa-angle-down'></i></th>
                                            <th id="marksListening">marks <i class='fas fa-angle-down'></i></th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider" id="recordShowListening">
                                    </tbody>
                                    <tfoot>

                                    </tfoot>
                            </table>
                        </div>
                        <div id="listeningpagination" class="mt-3"></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="v-pills-messages" role="tabpanel" aria-labelledby="v-pills-messages-tab">
                    <div class="table-responsive container mt-4 w-100 ">
                        <div style="min-height: 650px;">
                            <table class="table table-hover	table-responsive align-middle">
                                    <thead class="table-secondary">
                                        <caption>Good luck for next test</caption>
                                        <tr>
                                            <th>No</th>
                                            <th id="timeReading">time <i class='fas fa-angle-down'></i></th>
                                            <th id="professorReading">professor </th>
                                            <th id="professorEmailReading">professor Email </i></th>
                                            <th id="statusReading">status <i class='fas fa-angle-down'></i></th>
                                            <th id="marksReading">marks <i class='fas fa-angle-down'></i></th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider" id="recordShowReading">
                                    </tbody>
                                    <tfoot>

                                    </tfoot>
                            </table>
                        </div>
                        <div id="readingpagination" class="mt-3"></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="v-pills-settings" role="tabpanel" aria-labelledby="v-pills-settings-tab">
                    <div class="table-responsive container mt-4 w-100 ">
                        <div style="min-height: 650px;">
                            <table class="table table-hover	table-responsive align-middle">
                                    <thead class="table-secondary">
                                        <caption>Good luck for next test</caption>
                                        <tr>
                                            <th>No</th>
                                            <th id="timeSpeaking">time <i class='fas fa-angle-down'></i></th>
                                            <th id="professorSpeaking">professor </th>
                                            <th id="professorEmailSpeaking">professor Email </i></th>
                                            <th id="statusSpeaking">status <i class='fas fa-angle-down'></i></th>
                                            <th id="marksSpeaking">marks <i class='fas fa-angle-down'></i></th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider" id="recordShowSpeaking">
                                    </tbody>
                                    <tfoot>

        </tfoot>
    </table>
    <script>
        try {
            var WritingRecords = '{{writingTestData|safe}}';
            WritingRecords = WritingRecords.replace(/[\x00-\x1F\x7F]/g, '')
            WritingRecords = JSON.parse(WritingRecords);
        } catch (error) {
            WritingRecords = [];
            console.error('Error parsing JSON:', error);
        }

        try {
            var listeningTestData = '{{listeningTestData|safe}}';
            listeningTestData = listeningTestData.replace(/[\x00-\x1F\x7F]/g, '')
            listeningTestData = JSON.parse(listeningTestData);
        } catch (error) {
            listeningTestData = [];
            console.error('Error parsing JSON:', error);
        }

        try {
            var readingTestData = '{{readingTestData|safe}}';
            readingTestData = readingTestData.replace(/[\x00-\x1F\x7F]/g, '')
            readingTestData = JSON.parse(readingTestData);
        } catch (error) {
            readingTestData = [];
            console.error('Error parsing JSON:', error);
        }
        
        try {
            var speakingTestData = '{{speakingTestData|safe}}';
            speakingTestData = speakingTestData.replace(/[\x00-\x1F\x7F]/g, '')
            speakingTestData = JSON.parse(speakingTestData);
        } catch (error) {
            speakingTestData = [];
            console.error('Error parsing JSON:', error);
        }
        let sortingOrder = "ASC"
        let sortedBy = "time"
        records = get_sorting_order('DESC', 'checkedQuestion')
        add_records(records)
        
        //click listners
        $("#time").click(function () {
            var $icon = $('#time').find('i');
            if ($icon.attr('class') == 'fas fa-angle-down' || $icon.attr('class') == 'fa-angle-down fas' ){
                records = get_sorting_order('ASC', 'time')
                add_records(records)
                $icon.removeClass('fas fa-angle-down').addClass('fas fa-angle-up');
                $("#status i, #marks i").removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
            }
            else{
                records = get_sorting_order('DESC', 'time')
                add_records(records)
                $icon.removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
                $("#status i, #marks i").removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
            }
        });
        $("#status").click(function () {
            var $icon = $('#status').find('i');
            if ($icon.attr('class') == 'fas fa-angle-down' || $icon.attr('class') == 'fa-angle-down fas'){
                records = get_sorting_order('ASC','status')
                add_records(records)
                $icon.removeClass('fas fa-angle-down').addClass('fas fa-angle-up');
                $("#time i, #marks i").removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
            }
            else
            {
                records = get_sorting_order('DESC','status')
                add_records(records)
                $icon.removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
                $("#time i, #marks i").removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
            }
        });
        $('#marks').click(function () {
            var $icon = $('#marks').find('i');
            if ($icon.attr('class') == 'fas fa-angle-down' || $icon.attr('class') == 'fa-angle-down fas'){
                records = get_sorting_order('ASC','marks')
                add_records(records)
                $icon.removeClass('fas fa-angle-down').addClass('fas fa-angle-up');
                $("#time i, #status i").removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
            }
            else
            {
                records = get_sorting_order('DESC','marks')
                add_records(records)
                $icon.removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
                $("#time i, #status i").removeClass('fas fa-angle-up').addClass('fas fa-angle-down');
            }
        });

        //sorting function
        
        function get_sorting_order(sortingOrder = 'ASC', sortedBy = 'time') {
            if (sortingOrder == 'ASC') {
                if (sortedBy == 'time') {
                    records.sort(function (a, b) {
                        return new Date(a.timestamp) - new Date(b.timestamp);
                    });
                }
                else if (sortedBy == 'marks') {
                    records.sort(function (a, b) {
                        return a.studentObtainMarks - b.studentObtainMarks;
                    });
                }
                //else if (sortedBy == 'status') {
                //        records.sort(function (a, b) {
                //        return a.status - b.status;
                //    });                    
                //}

            }
            else {
                if (sortedBy == 'time') {
                    records.sort(function (a, b) {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
                }
                else if (sortedBy == 'marks') {
                    records.sort(function (a, b) {
                        return b.studentObtainMarks - a.studentObtainMarks;
                    });
                }
                else if (sortedBy == 'status') {
                    records.sort(function (a, b) {
                        return b.checkedQuestion - a.checkedQuestion;
                    });
                }
            }
            return records;
        }

        function getCurrentFormattedDate(dateTime) {
            const months = [
                "JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE",
                "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"
            ];

            const dateObj = new Date(dateTime);

            const day = dateObj.getDate();
            const month = months[dateObj.getMonth()];
            const year = dateObj.getFullYear();

            let hour = dateObj.getHours();
            const minute = dateObj.getMinutes();
            const ampm = hour >= 12 ? "PM" : "AM";

            // Convert to 12-hour clock format
            if (hour > 12) {
                hour -= 12;
            } else if (hour === 0) {
                hour = 12;
            }

            return `${day}-${month}-${year} ${hour}:${minute.toString().padStart(2, '0')} ${ampm}`;
        }

        function add_records(records) {
            records = JSON.parse(records)
            $("#recordShow").empty();
            for (var i=0; i<records.length; i++) {
                var inputTr = "<tr class=''><td>" + (Number(i) + 1) + "</td><td>" + getCurrentFormattedDate(records[i].timestamp) + "</td><td>Writing Test</td><td>" + records[i].teacher.username + "</td><td>" + records[i].teacher.email + "</td>";
                if (records[i].checkedQuestion) {
                    inputTr += "<td><span class='badge rounded-pill bg-success'>Checked</span></td><td>" + records[i].studentObtainMarks + "</td></tr>"
                }
                else {
                    inputTr += "<td><span class='badge rounded-pill bg-secondary'>Not Checked</span></td><td>" + records[i].studentObtainMarks + "</td></tr>"
                }

                $("#recordShow").append(inputTr);
                console.log(inputTr);
            }
        }
    </script>
</div>

{% endblock content %}